name: Feishu Daily Reminder

on:
  schedule:
    # UTC time. Beijing is UTC+8.
    - cron: '30 1 * * *'   # 09:30 CST (Morning)
    - cron: '30 4 * * *'   # 12:30 CST (Lunch)
    - cron: '00 11 * * *'  # 19:00 CST (Evening)
  workflow_dispatch:
    inputs:
      reminder_type:
        description: 'Reminder Type (morning/lunch/evening)'
        required: false
        default: 'auto'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Determine Type
        id: type
        shell: bash
        run: |
          # If manual trigger with specific type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.reminder_type }}" != "auto" ]; then
             echo "type=${{ inputs.reminder_type }}" >> $GITHUB_OUTPUT
             exit 0
          fi
          
          # Auto detection based on Beijing Time
          # GitHub Runners are UTC. We need to shift to Beijing (UTC+8)
          # Using TZ variable works for date command
          current_hour=$(TZ='Asia/Shanghai' date +%H)
          echo "Current hour in Beijing: $current_hour"
          
          # Logic:
          # < 11:00 -> Morning (09:30)
          # < 15:00 -> Lunch (12:30)
          # >= 15:00 -> Evening (19:00)
          
          if [ "$current_hour" -lt 11 ]; then
            echo "type=morning" >> $GITHUB_OUTPUT
          elif [ "$current_hour" -lt 15 ]; then
            echo "type=lunch" >> $GITHUB_OUTPUT
          else
            echo "type=evening" >> $GITHUB_OUTPUT
          fi

      - name: Run Reminder
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          echo "Running reminder for: ${{ steps.type.outputs.type }}"
          python src/main.py ${{ steps.type.outputs.type }}
